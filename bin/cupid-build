#!/usr/bin/env node

var fs = require('fs')
var path = require('path')
var cupid = require('../')
var log = require('../lib/utils').log
var error = require('../lib/utils').error


var args = process.argv.slice(2)
var arg0 = args[0]
var planet = require('../lib/planet')(arg0.charAt(0) !== '-' && arg0)

if (!planet) {
  error('can not find planet.json file')
  process.exit(1)
}


var data = require(planet + '/planet.json')

cupid.read(data.feeds).done(function(feeds) {
  var props = 'author link site title subtitle updated'.split(' ')

  feeds = feeds.map(cupid.unify).map(cupid.normalize)

  feeds.forEach(function(feed, i) {
    props.forEach(function(p) {
      data.feeds[i][p] = feed[p]
    })
  })

  data.posts = cupid.aggregate(feeds)
  data.dir = planet

  cupid.write(data)

  log('done', 'build ' + data.title + ' succeed')
  log('done', 'check the build result at ' + data.dir)
  process.exit(0)
})

process.stdin.resume()
