#!/usr/bin/env node

var exists = require('fs').existsSync
var join = require('path').join
var cupid = require('../')
var log = require('../lib/utils').log
var error = require('../lib/utils').error


var args = process.argv.slice(2)
var dir = args.length > 0 ? args[0] : ''
var cwd = process.cwd()
var planet = join(cwd, dir)

if (!exists(join(planet, 'planet.json'))) {
  error('cannot find planet folder to build')
  process.exit(1)
}

var data = require(join(planet, 'planet.json'))

cupid.read(data.feeds).done(function(feeds) {
  var props = 'author link site title subtitle updated'.split(' ')

  feeds = feeds.map(cupid.unify).map(cupid.normalize)

  feeds.forEach(function(feed, i) {
    props.forEach(function(p) {
      data.feeds[i][p] = feed[p]
    })
  })

  data.posts = cupid.aggregate(feeds)
  data.dir = planet

  cupid.write(data)

  log('done', 'build ' + data.title + ' succeed')
  log('done', 'check the build result at ' + data.dir)
  process.exit(0)
})

process.stdin.resume()
