#!/usr/bin/env node

var program = require('commander')
var join = require('path').join
var exists = require('fs').existsSync
var spawn = require('child_process').spawn
var pkg = require('../package.json')

program.version(pkg.version)

program.on('--help', function() {
  console.log('  Examples:')
  console.log('')
  console.log('    $ cupid')
  console.log('    $ cupid server')
  console.log('')
})

program.parse(process.argv)


var cmd = program.args[0]

var aliases = {
  b: 'build',
  s: 'server',
  serve: 'server'
}

function alias(cmd) {
  return aliases[cmd] || cmd
}

var bin = 'cupid-' + alias(cmd)
var local = join(__dirname, bin)
var args = process.argv.slice(2)
var arg0 = args[0]
var planet = require('../lib/planet')(arg0.charAt(0) !== '-' && arg0)

if (exists(local)) {
  args = args.slice(1)
  bin = local
}
else if (planet) {
  bin = join(__dirname, 'cupid-build')
}
else {
  process.stdout.write(program.helpInformation());
  program.emit('--help');
  process.exit();
}

var proc = spawn(bin, args, { stdio: 'inherit', customFds: [0, 1, 2] })

proc.on('close', function(code){
  process.exit(code)
})