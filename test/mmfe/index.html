<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Alimama FE</title>
    <link rel="stylesheet" href="https://g.alicdn.com/thx/cube/1.3.1/??cube.css,type.css">
    <link rel="stylesheet" href="app.css">
    <link type="application/atom+xml" rel="alternate" href="feed.xml" title="Alimama FE" />
  </head>
  <body>
    <section id="page" class="collapsed">
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">不要在控制台上使用 let/const - 紫云飞</h1>
        <p class="post-meta">
          <a href="http://www.cnblogs.com/ziyunfei/p/6063426.html" target="_blank"
            <time datetime="2016-11-15T19:31:00+0800" itemProp="datePublished">Nov 15, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://www.cnblogs.com/ziyunfei/" target="_blank" itemprop="url">
              <span itemprop="name">紫云飞</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody">【摘要】考虑下面的这三句代码和对应的报错信息： 假设写这个代码的人一开始不知道 ES6 里新增的构造函数不能省略 new，于是第一行写错了。然后第二行尝试重新声明一次，结果又报错说重复声明了。那干脆不声明，直接赋值总行吧，结果又报错说 map 未定义。 这三个报错直接对应规范里的下面三条规则（并附通俗解释） <a href="http://www.cnblogs.com/ziyunfei/p/6063426.html" target="_blank">阅读全文</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">用 const 还是用 let？ - 紫云飞</h1>
        <p class="post-meta">
          <a href="http://www.cnblogs.com/ziyunfei/p/6038213.html" target="_blank"
            <time datetime="2016-11-11T17:33:00+0800" itemProp="datePublished">Nov 11, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://www.cnblogs.com/ziyunfei/" target="_blank" itemprop="url">
              <span itemprop="name">紫云飞</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody">【摘要】ES6 里新增了两种声明变量的方式，let 和 const，加上原来的 var，一共就有三种方式来声明变量了。那到底该用哪个呢？关于“尽可能不用 var” 这一点，大家应该没有什么意见分歧（其实还是有少数人不这么想的），关于“是用 let 还是用 const”，社区里主要有两种不同的观点： 1. 默 <a href="http://www.cnblogs.com/ziyunfei/p/6038213.html" target="_blank">阅读全文</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">为什么为 const 变量重新赋值不是个静态错误 - 紫云飞</h1>
        <p class="post-meta">
          <a href="http://www.cnblogs.com/ziyunfei/p/6043513.html" target="_blank"
            <time datetime="2016-11-10T00:12:00+0800" itemProp="datePublished">Nov 10, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://www.cnblogs.com/ziyunfei/" target="_blank" itemprop="url">
              <span itemprop="name">紫云飞</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody">【摘要】const 和 let 的唯一区别就是用 const 声明的变量不能被重新赋值（只读变量），比如像下面这样就会报错： const foo = 1 foo = 2 // TypeError: Assignment to constant variable. 但遗憾的是，这个错误不是个静态错误（stat <a href="http://www.cnblogs.com/ziyunfei/p/6043513.html" target="_blank">阅读全文</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">带有“非简单参数”的函数为什么不能包含 &quot;use strict&quot; 指令 - 紫云飞</h1>
        <p class="post-meta">
          <a href="http://www.cnblogs.com/ziyunfei/p/5926123.html" target="_blank"
            <time datetime="2016-11-01T21:11:00+0800" itemProp="datePublished">Nov 1, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://www.cnblogs.com/ziyunfei/" target="_blank" itemprop="url">
              <span itemprop="name">紫云飞</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody">【摘要】非简单参数就是 ES6 里新加的参数语法，包括：1.默认参数值、2.剩余参数、3.参数解构。本文接下来要讲的就是 ES7 为什么禁止在使用了非简单参数的函数里使用 "use strict" 指令： function f(foo = "bar") { "use strict" // SyntaxErr <a href="http://www.cnblogs.com/ziyunfei/p/5926123.html" target="_blank">阅读全文</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">[翻译]bash的各种文件载入执行顺序</h1>
        <p class="post-meta">
          <a href="http://jser.me/2016/09/29/bash%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.html" target="_blank"
            <time datetime="2016-09-29T08:21:42+0800" itemProp="datePublished">Sep 29, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://jser.me" target="_blank" itemprop="url">
              <span itemprop="name">草依山的Javascript世界</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody"><p>[注] 一直以来都没有搞清楚 <code class="highlighter-rouge">bash</code> 里各种文件的载入顺序，<a href="http://www.thegeekstuff.com/2008/10/execution-sequence-for-bash_profile-bashrc-bash_login-profile-and-bash_logout/">这是一篇好文</a>，顺手翻译一下。</p>

<p>这篇文章解释了下面这些文件载入执行的顺序：</p>

<ul>
  <li>/etc/profile</li>
  <li>~/.bash_profile</li>
  <li>~/.bashrc</li>
  <li>~/.bash_login</li>
  <li>~/.profile</li>
  <li>~/.bash_logout</li>
</ul>

<h2 id="shell-">登录过的可交互 shell 的执行顺序</h2>

<p>下面的伪代码解释了这些文件的执行顺序</p>

<div class="highlighter-rouge"><pre class="highlight"><code>execute /etc/profile
IF ~/.bash_profile exists THEN
    execute ~/.bash_profile
ELSE
    IF ~/.bash_login exist THEN
        execute ~/.bash_login
    ELSE
        IF ~/.profile exist THEN
            execute ~/.profile
        END IF
    END IF
END IF
</code></pre>
</div>

<p>退出 shell 的时候，按照下面的执行顺序：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>IF ~/.bash_logout exists THEN
    execute ~/.bash_logout
END IF
</code></pre>
</div>

<p>需要注意的是 <code class="highlighter-rouge">/etc/bashrc</code> 是像下面这样被 <code class="highlighter-rouge">~/.bashrc</code> 调用执行的：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># cat ~/.bashrc
if [ -f /etc/bashrc ]; then
. /etc/bashrc
fi
</code></pre>
</div>

<h2 id="shell--1">非登录的可交互 shell 的执行顺序</h2>

<p>当运行一个没有登录的可交互 shell 的时候，下面是它的执行顺序：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>IF ~/.bashrc exists THEN
    execute ~/.bashrc
END IF
</code></pre>
</div>

<p>注意: 当一个非登录的可交互 shell 启动的时候，它会查找 ENV 环境变量，然后执行 ENV 环境变量标识的文件名</p>

<h2 id="section">测试执行顺序</h2>

<p>测试执行顺序的一个方法是给这些文件添加不同的 PS1 值，然后重新登录 shell，看看都有哪些值被显示出来。我们之前有讨论过如何使用 PS1 来使你的 Linux 提示符即好看又实用。</p>

<ol>
  <li>/etc/profile 被执行。 添加下面的 PS1 行到 <code class="highlighter-rouge">/etc/profile</code> 然后重新登录，确保提示符已经变成了这个文件里设置的样子。</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code># grep PS1 /etc/profile
PS1="/etc/profile&gt; "

[Note: re-login to see the prompt change as shown below]
Last login: Sat Sep 27 16:43:57 2008 from 192.168.1.2
/etc/profile&gt;
</code></pre>
</div>
<p>为了保证正常执行，需要确保 <code class="highlighter-rouge">~/.bash_profile</code> 里没有别的 PS1 赋值。</p>

<ol>
  <li>~/.bash_profile 被执行: 添加下面的 PS1 到 ~/.bash_profile, ~/.bash_login, ~/.profile and ~/.bashrc。 重新登录一下，确认提示符像下面这样变成了 <code class="highlighter-rouge">~/.bash_profile</code> 里设置的内容。</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code>/etc/profile&gt; grep PS1 ~/.bash_profile
export PS1="~/.bash_profile&gt; "

/etc/profile&gt; grep PS1 ~/.bash_login
export PS1="~/.bash_login&gt; "

/etc/profile&gt; grep PS1 ~/.profile
export PS1="~/.profile&gt; "

/etc/profile&gt; grep PS1 ~/.bashrc
export PS1="~/.bashrc&gt; "

[注意: 由于重新登录, 先执行 /etc/profile 然后 ~/.bash_profile。
所以 PS1 会是  ~/.bash_profile 里设置的.
由于 ~/.bash_profile 的存在, 它不会执行  ~/.bash_login ]
Last login: Sat Sep 27 16:48:11 2008 from 192.168.1.2
~/.bash_profile&gt;
</code></pre>
</div>

<ol>
  <li>~/.bash_login 被执行。 把 <code class="highlighter-rouge">.bash_profile</code> 重命名一下。重新登录确认提示符像下面这样变成 <code class="highlighter-rouge">~/.bash_login</code> 里设置的。</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code>~/.bash_profile&gt; mv .bash_profile bash_profile_not_used

[注意: 由于重新登录，它先执行 `/etc/profile`。
同时由于找不到 `~/.bash_profile`， 它执行 `~/.bash_login`]
Last login: Sat Sep 27 16:50:55 2008 from 192.168.1.2
~/bash_login&gt;
</code></pre>
</div>

<ol>
  <li>~/.profile 被执行。重命名 <code class="highlighter-rouge">.bash_login</code>。重新登录确认提示符像下面这样变成了 <code class="highlighter-rouge">~/.profile</code> 里设置的。</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code>~/.bash_login&gt; mv .bash_login bash_login_not_used

[注意: 由于重新登录，它先执行 `/etc/profile`。
同时由于找不到 `~/.bash_profile` 和 `~/.bash_login`， 它执行 `~/.profile`]
Last login: Sat Sep 27 16:56:36 2008 from 192.168.1.2
~/.profile&gt;
</code></pre>
</div>

<ol>
  <li>~/.bashrc 被非登录执行。 在终端里执行 <code class="highlighter-rouge">bash</code>，将会产生一个非登录shell，它会执行 <code class="highlighter-rouge">.bashrc</code>。</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code>~/.profile&gt; bash

[注意: 下面显示的 PS1 来自 `.bashrc`。 ]
~/.bashrc&gt; exit
exit

[注意: 从非登录 shell 里退出后，回到登录后的 shell]
~/.profile&gt;
</code></pre>
</div>
<br>文章来源： <a href="http://jser.me/2016/09/29/bash%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.html">[翻译]bash的各种文件载入执行顺序</a> <br> 文章的标签：  <a href="http://jser.me/tag.html#shell" class="tag">shell</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">arguments 对象的老历史 - 紫云飞</h1>
        <p class="post-meta">
          <a href="http://www.cnblogs.com/ziyunfei/p/5890322.html" target="_blank"
            <time datetime="2016-09-21T20:48:00+0800" itemProp="datePublished">Sep 21, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://www.cnblogs.com/ziyunfei/" target="_blank" itemprop="url">
              <span itemprop="name">紫云飞</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody">【摘要】引题：为什么 JavaScript 中的 arguments 对象不是数组 http://www.zhihu.com/question/50803453 JavaScript 1.0 1995 年， Brendan Eich 在 Netscape Navigator 2.0 中实现了 JavaScr <a href="http://www.cnblogs.com/ziyunfei/p/5890322.html" target="_blank">阅读全文</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">去掉你代码里的 document.write(&quot;&lt;script... - 紫云飞</h1>
        <p class="post-meta">
          <a href="http://www.cnblogs.com/ziyunfei/p/5881426.html" target="_blank"
            <time datetime="2016-09-18T14:13:00+0800" itemProp="datePublished">Sep 18, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://www.cnblogs.com/ziyunfei/" target="_blank" itemprop="url">
              <span itemprop="name">紫云飞</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody">【摘要】在传统的浏览器中，同步的 script 标签是会阻塞 HTML 解析器的，无论是内联的还是外链的，比如： 在这个例子中，HTML 解析器会先解析到第一个 script 标签，然后暂停解析，转而去下载 a.js，下载完后开始执行，执行完后，才会继续解析、下载、执行后面的两个 script 标签，最后解 <a href="http://www.cnblogs.com/ziyunfei/p/5881426.html" target="_blank">阅读全文</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">SameSite Cookie，防止 CSRF 攻击 - 紫云飞</h1>
        <p class="post-meta">
          <a href="http://www.cnblogs.com/ziyunfei/p/5637945.html" target="_blank"
            <time datetime="2016-07-12T20:13:00+0800" itemProp="datePublished">Jul 12, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://www.cnblogs.com/ziyunfei/" target="_blank" itemprop="url">
              <span itemprop="name">紫云飞</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody">【摘要】因为 HTTP 协议是无状态的，所以很久以前的网站是没有登录这个概念的，直到网景发明 cookie 以后，网站才开始利用 cookie 记录用户的登录状态。cookie 是个好东西，但它很不安全，其中一个原因是因为 cookie 最初被设计成了允许在第三方网站发起的请求中携带，CSRF 攻击就是利用 <a href="http://www.cnblogs.com/ziyunfei/p/5637945.html" target="_blank">阅读全文</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">扼杀 304，Cache-Control: immutable - 紫云飞</h1>
        <p class="post-meta">
          <a href="http://www.cnblogs.com/ziyunfei/p/5642796.html" target="_blank"
            <time datetime="2016-07-06T20:02:00+0800" itemProp="datePublished">Jul 6, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://www.cnblogs.com/ziyunfei/" target="_blank" itemprop="url">
              <span itemprop="name">紫云飞</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody">【摘要】随着近些年社交网站的流行，越来越多的人学会了“刷”网页 ── 刷微博，刷朋友圈，刷新闻，刷秒杀页。这里的“刷”，就是刷新的意思，在浏览器里，你可以通过点击刷新按钮，或者用快捷键，或者移动端的下拉操作来进行刷新。 但普通网民不知道的是，通过刷新操作导致的页面加载和通过其他操作（比如点击页面链接，地址栏 <a href="http://www.cnblogs.com/ziyunfei/p/5642796.html" target="_blank">阅读全文</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">V8 的 typeof null 返回 &quot;undefined&quot; 的 bug 是怎么回事 - 紫云飞</h1>
        <p class="post-meta">
          <a href="http://www.cnblogs.com/ziyunfei/p/5618152.html" target="_blank"
            <time datetime="2016-06-26T20:29:00+0800" itemProp="datePublished">Jun 26, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://www.cnblogs.com/ziyunfei/" target="_blank" itemprop="url">
              <span itemprop="name">紫云飞</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody">【摘要】1997 年，IE 4.0 发布，带来的众多新特性中有一个对未来“影响深远”的 DOM API：document.all。在随后的 6 年里，IE 的市场占有率越来越高，直到 2003 年的 95%。 在这段时间里，产生了两种成千上万的页面。第一种：IE only 的页面，由于超高的市场占有率，开发 <a href="http://www.cnblogs.com/ziyunfei/p/5618152.html" target="_blank">阅读全文</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">IntersectionObserver API - 紫云飞</h1>
        <p class="post-meta">
          <a href="http://www.cnblogs.com/ziyunfei/p/5558712.html" target="_blank"
            <time datetime="2016-06-13T18:57:00+0800" itemProp="datePublished">Jun 13, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://www.cnblogs.com/ziyunfei/" target="_blank" itemprop="url">
              <span itemprop="name">紫云飞</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody">【摘要】温馨提示：本文目前仅适用于在 Chrome 51 及以上中浏览。 2016.11.1 追加，Firefox 52 也已经实现。 IntersectionObserver API 是用来监视某个元素是否滚动进了浏览器窗口的可视区域（视口）或者滚动进了它的某个祖先元素的可视区域内。它的主要功能是用来实现 <a href="http://www.cnblogs.com/ziyunfei/p/5558712.html" target="_blank">阅读全文</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">phantomjs在linux下截图中文字体问题</h1>
        <p class="post-meta">
          <a href="http://jser.me/2016/05/31/phantomjs%E5%9C%A8linux%E4%B8%8B%E6%88%AA%E5%9B%BE%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93%E9%97%AE%E9%A2%98.html" target="_blank"
            <time datetime="2016-05-31T10:57:57+0800" itemProp="datePublished">May 31, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://jser.me" target="_blank" itemprop="url">
              <span itemprop="name">草依山的Javascript世界</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody"><p>最近搞了搞截图的事情，碰到点小问题，刚解决完，趁着手热，记录一下。
目前我们截图用的是 <a href="https://github.com/brenden/node-webshot">webshot</a>，它封装 <a href="http://phantomjs.org">phantomjs</a>，使用起来比较方便，唯一碰到的问题就是中文展现与
真实浏览器里的有区别，问题其实就是字体的问题</p>

<p>我们的样式里是这样：</p>

<div class="language-css highlighter-rouge"><pre class="highlight"><code><span class="o">...</span><span class="p">{</span>
  <span class="err">...</span>
  <span class="nl">font-family</span><span class="p">:</span> <span class="n">Helvetica</span><span class="p">,</span> <span class="n">arial</span><span class="p">,</span> <span class="s1">"microsoft yahei"</span><span class="p">,</span> <span class="n">Monaco</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span>
  <span class="err">...</span>
<span class="p">}</span>
</code></pre>
</div>

<p>只截取了字体设置的那段，可以看到有 5 种字体，最后的 sans-serif 默认对应是黑体，需要把这5种字体装到截图的
 Linux 服务器，分别从osx和windows上copy出来，注意一下，osx 中的字体是 <code class="highlighter-rouge">.ttc</code> 和 <code class="highlighter-rouge">.dfont</code> 格式的，我们
可以借助 <a href="http://transfonter.org/ttc-unpack">http://transfonter.org/ttc-unpack</a>来转换为 Linux
支持的 <code class="highlighter-rouge">.ttf</code> 的格式</p>

<ul>
  <li>Helvetica       : 从 osx 的 /System/Library/Fonts 拷然后转换</li>
  <li>arial           : 从windows拷</li>
  <li>sans-serif      : 默认是黑体，从 osx 拷</li>
  <li>microsoft yahei : 从windows拷</li>
  <li>Monaco          : 从windows拷</li>
</ul>

<p>把这些文件拷到 Linux 服务器上，然后调用 <code class="highlighter-rouge">fc-cache</code> 更新一下</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo mkdir /usr/share/fonts/custom
sudo cp <span class="k">*</span>.ttf  /usr/share/fonts/custom
<span class="nb">fc</span>-cache -fv
</code></pre>
</div>

<p>如果你之前曾经在网上搜索并安装了 <code class="highlighter-rouge">bitmap-fonts</code> ，还是删除吧</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo yum remove bitmap-fonts bitmap-fonts-cjk  <span class="c"># 删除之前安装的东西</span>
</code></pre>
</div>

<p>更新完字体后截图就正常了</p>

<br>文章来源： <a href="http://jser.me/2016/05/31/phantomjs%E5%9C%A8linux%E4%B8%8B%E6%88%AA%E5%9B%BE%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93%E9%97%AE%E9%A2%98.html">phantomjs在linux下截图中文字体问题</a> <br> 文章的标签：  <a href="http://jser.me/tag.html#nodejs" class="tag">nodejs</a>  <a href="http://jser.me/tag.html#phantomjs" class="tag">phantomjs</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">Promise的错误处理</h1>
        <p class="post-meta">
          <a href="http://jser.me/2016/04/24/Promise%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86.html" target="_blank"
            <time datetime="2016-04-24T22:14:57+0800" itemProp="datePublished">Apr 24, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://jser.me" target="_blank" itemprop="url">
              <span itemprop="name">草依山的Javascript世界</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody"><p>距离上一次写 blog 已经又过去了两月有余，一周一篇的目标很难到达呀，借口就不找了，尽力弥补吧。</p>

<p>今天我们来说一说 Promise 的错误处理，随着 ES6(aka ES2015) 开始普及，以及越来越多的 Nodejs 应用出现，Promise 作为处理异步的一种重要工具，在我们日常的工作中使用也越来越频繁，本文不准备就 Promise 的基本概念及功能作一些描述，推荐两篇文章（<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Promise">MDN Promise</a>, <a href="http://fex.baidu.com/blog/2015/07/we-have-a-problem-with-promises/">We have a problem with promises中文</a>）足以让你对Promise非常了解。</p>

<p>我们今天专门讲一下 Promise 的错误处理。</p>

<p><code class="highlighter-rouge">promise.then</code> 方法接收两个回调函数为参数，其中第一个为成功回调函数，第二个为失败回调函数，需要注意的是
这儿的两个回调函数基于<code class="highlighter-rouge">promsie</code>这个 Promise 实例的处理结果的，比如：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'jser down'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'never here'</span><span class="p">)</span>
  <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="c1">// jser down</span>
  <span class="p">})</span>
</code></pre>
</div>
<p>如果你想捕捉 <code class="highlighter-rouge">then</code> 的成功回调函数的错误，那需要再写一个 <code class="highlighter-rouge">then</code> 加上失败的错误回调，简而言之就是：<code class="highlighter-rouge">then</code>
里的错误处理函数是对上一个处理过程的错误捕捉。</p>

<p>那么，对于一个常见的错误处理可能是这样的：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'a:1'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">json</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
  <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">//这儿捕获的是上一个JSON.parse时的错误</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="c1">//Unexpected token a</span>
  <span class="p">})</span>
</code></pre>
</div>

<p>常见的一级一级的异步处理任务，用这种错误捕捉代码就显得太难看了，打码效率也低效了，应好有 <code class="highlighter-rouge">catch</code> 来统一处理：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'{"a":1}'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">json</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">a</span><span class="o">++</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'error 1'</span><span class="p">))</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'error 2'</span><span class="p">))</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="c1">//error 1</span>
  <span class="p">})</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">catch</code> 很方便的解决了我们对于多级 <code class="highlighter-rouge">Promise</code> 处理的问题，那对于一些忘记加或者无法加 <code class="highlighter-rouge">catch</code>
的情况怎么处理呢？庆幸的是 API 的设计者们又为我们这些应用开发者想好了，有一个全局的事情叫
<code class="highlighter-rouge">unhandledRejection</code> 这个事件在浏览器( <a href="https://googlechrome.github.io/samples/promise-rejection-events/">Chrome 49+</a> )和 Nodejs 里名称稍微有点不一样，浏览器里是全小写的
<code class="highlighter-rouge">unhandledrejection</code> 。 比如：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'unhandledRejection'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="c1">// [Error: unhandledrejection]</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span> <span class="c1">// Promise { &lt;rejected&gt; [Error: unhandledrejection] }</span>
<span class="p">})</span>

<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'unhandledrejection'</span><span class="p">))</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
</code></pre>
</div>

<p>在浏览器里，我们需要 <code class="highlighter-rouge">window.addEventListener("unhandledrejection", (e)=&gt;{})</code> ，在
Web Workers 里需要使用 <code class="highlighter-rouge">self.addEventListener</code>，我们来写一个简单的小模块，把 Nodejs 、浏览器以及
 Web Workers 里的情况统一一下：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">onUnhandledRejection</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">isNode</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">process</span> <span class="o">===</span> <span class="s1">'object'</span> <span class="o">&amp;&amp;</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">process</span><span class="p">)</span> <span class="o">===</span> <span class="s1">'[object process]'</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">isNode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'unhandledRejection'</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'unhandledrejection'</span><span class="p">,</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">promise</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">})()</span>

<span class="cm">/* 使用：
onUnhandledRejection((r,p) =&gt; {
  console.log(r)
})
*/</span>
</code></pre>
</div>
<p>OK ，今天的小文就到此为止啦。</p>
<br>文章来源： <a href="http://jser.me/2016/04/24/Promise%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86.html">Promise的错误处理</a> <br> 文章的标签：  <a href="http://jser.me/tag.html#javascript" class="tag">javascript</a>  <a href="http://jser.me/tag.html#promise" class="tag">promise</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">URL里的+</h1>
        <p class="post-meta">
          <a href="http://jser.me/2016/02/23/URL%E9%87%8C%E7%9A%84+.html" target="_blank"
            <time datetime="2016-02-23T14:15:19+0800" itemProp="datePublished">Feb 23, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://jser.me" target="_blank" itemprop="url">
              <span itemprop="name">草依山的Javascript世界</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody"><p>最近一个同学反馈用我做的某个工具的时候，明明form提交的值里是空格，但是拿到的是参数值里变成了+号，
回想一下并没有在form提交的时候做这种转换呀，那是哪儿转出来的呢？</p>

<p>做了一个小例子：</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span> 测试form <span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"hello world"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">value=</span><span class="s">"click"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>没有指定form的enctype，我们都知道form的默认enctype是<code class="highlighter-rouge">application/x-www-form-urlencoded</code>，
如果在输入框里输入了空格，比如<code class="highlighter-rouge">hello world</code>，点击click之后，页面中的链接就会变成：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>http://localhost:3000/?hello+world=hello+world
</code></pre>
</div>

<p>这里没有任何后端服务，那么确实是浏览器把空格替换成了<code class="highlighter-rouge">+</code>，那如果就是想在值里有一个<code class="highlighter-rouge">+</code>怎么办？
输入<code class="highlighter-rouge">hello+world</code>，得到的链接是：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>http://localhost:3000/?hello+world=hello%2Bworld
</code></pre>
</div>

<p><code class="highlighter-rouge">+</code>会转成<code class="highlighter-rouge">%2B</code>，<code class="highlighter-rouge">+</code>号对应的unicode编码是43，十六进制是2B，在URL里用%2B表示也是正常</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="s1">'+'</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="c1">//2b</span>
</code></pre>
</div>

<p>那这个转换行为是规范里的吗？找了一下，确实是<a href="https://www.w3.org/TR/html401/interact/forms.html#h-17.13.4.1">https://www.w3.org/TR/html401/interact/forms.html#h-17.13.4.1</a>，我把它摘抄一下：</p>

<blockquote>
  <h4 id="applicationx-www-form-urlencoded">application/x-www-form-urlencoded</h4>
  <p>This is the default content type. Forms submitted with this content type must be encoded as follows:</p>

  <p>Control names and values are escaped. Space characters are replaced by ‘+’, and then reserved characters are escaped as described in [RFC1738], section 2.2: Non-alphanumeric characters are replaced by ‘%HH’, a percent sign and two hexadecimal digits representing the ASCII code of the character. Line breaks are represented as “CR LF” pairs (i.e., ‘%0D%0A’).
The control names/values are listed in the order they appear in the document. The name is separated from the value by ‘=’ and name/value pairs are separated from each other by ‘&amp;’.</p>
</blockquote>

<p>对应我们这个问题就是，键与值都要被转义，空格要被转为<code class="highlighter-rouge">+</code>，非字母与数字转为一个%号与两位16进制的ASCII值，这下明确了，就是浏览器按规范进行了转换。</p>

<p>那一般的框架在处理请求的时候应该也会对这个URL进行反转义，也就是把<code class="highlighter-rouge">+</code>号转为空格，我们来测试一下NodeJS:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">urlModule</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'url'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">urlStr</span> <span class="o">=</span> <span class="s1">'http://localhost:3000/?hello+world=good+hello+%2B+hell'</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">urlModule</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">urlStr</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span>

<span class="c1">//返回下面的值</span>
<span class="c1">// Url {</span>
<span class="c1">//   protocol: 'http:',</span>
<span class="c1">//   slashes: true,</span>
<span class="c1">//   auth: null,</span>
<span class="c1">//   host: 'localhost:3000',</span>
<span class="c1">//   port: '3000',</span>
<span class="c1">//   hostname: 'localhost',</span>
<span class="c1">//   hash: null,</span>
<span class="c1">//   search: '?hello+world=good+hello+%2B+hell',</span>
<span class="c1">//   query: { 'hello world': 'good hello + hell' },</span>
<span class="c1">//   pathname: '/',</span>
<span class="c1">//   path: '/?hello+world=good+hello+%2B+hell',</span>
<span class="c1">//   href: 'http://localhost:3000/?hello+world=good+hello+%2B+hell' }</span>
</code></pre>
</div>
<p>可见NodeJS的处理也是没有问题，为什么我的程序里有问题呢？好吧，因为我们有些历史URL是GB2312的编码，为了对这些URL进行兼容，自己单独写了一个
URL parse的方法，没有处理<code class="highlighter-rouge">+</code>号的这种情况。</p>

<p>至此，真相大白，本周一篇目标达到，耶~</p>
<br>文章来源： <a href="http://jser.me/2016/02/23/URL%E9%87%8C%E7%9A%84+.html">URL里的+</a> <br> 文章的标签：  <a href="http://jser.me/tag.html#html" class="tag">html</a>  <a href="http://jser.me/tag.html#form" class="tag">form</a>  <a href="http://jser.me/tag.html#nodejs" class="tag">nodejs</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">N个数中第K大的数</h1>
        <p class="post-meta">
          <a href="http://jser.me/2016/02/11/N%E4%B8%AA%E6%95%B0%E4%B8%AD%E7%AC%ACK%E5%A4%A7%E7%9A%84%E6%95%B0.html" target="_blank"
            <time datetime="2016-02-11T14:22:22+0800" itemProp="datePublished">Feb 11, 2016</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://jser.me" target="_blank" itemprop="url">
              <span itemprop="name">草依山的Javascript世界</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody"><p>过年了看一下博客，去年产量好低，今年争取一周至少一篇吧，水的也行，嘿嘿（注意这儿只有两个嘿嘿，它是语气词，不是动词）。</p>

<p>我们看一下求N个数(可重复)中第K大的数怎么搞，
首先最常见的思路肯定就是先把N个数进行去重排序，我们可以用一下ES6的Set去重，然后用数组sort排序，最后取第K大的就行</p>

<p>下面的代码用到了一些ES6的特性，建议安装babel(npm install -g babel)，然后在命令行下使用babel-node运行</p>

<p>或者可以在我弄的这个<a href="http://jser.me/demos/es6-run.html">网页版的repl</a>里运行代码，在控制台里看结果</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">q</span> <span class="p">(</span><span class="nx">arry</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">uniqArry</span> <span class="o">=</span> <span class="p">[...</span><span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">arry</span><span class="p">)]</span>
  <span class="k">return</span> <span class="nx">uniqArry</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span><span class="p">)[</span><span class="nx">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">q</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="mi">5</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">q</span><span class="p">([</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span> <span class="o">===</span> <span class="mi">6</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">q</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="mi">5</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">q</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">355</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="mi">5</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">q</span><span class="p">([</span><span class="mi">31</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
    <span class="mi">37</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
    <span class="mi">33</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>
    <span class="mi">36</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">9</span> <span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="o">===</span> <span class="mi">16</span><span class="p">)</span>
</code></pre>
</div>

<p>同时我在下面写了五个测试用例，运行一下返回两个true就行啦</p>

<p>这篇太水了，下面补上一个稍微复杂一点的解法，第二种方法同样是先利用Set去重，然后先取前k个数排序，
再把后面的<code class="highlighter-rouge">m-k</code>个数挨个处理一下，比排序后最大的数还小，那就插入到排序数组里特定的位置,
同时数组pop出一个元素，最后取排序后数组里最后一个元素就是所需要的结果。</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">q</span> <span class="p">(</span><span class="nx">arry</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">uniqArry</span> <span class="o">=</span> <span class="p">[...</span><span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">arry</span><span class="p">)]</span>
  <span class="kd">let</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">uniqArry</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">k</span><span class="p">).</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span><span class="p">)</span>
  <span class="kd">let</span> <span class="nx">cur</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">uniqArry</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cur</span> <span class="o">=</span> <span class="nx">uniqArry</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">&lt;</span> <span class="nx">tmp</span><span class="p">[</span><span class="nx">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span> <span class="c1">// 比最大小</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">m</span> <span class="o">&lt;</span> <span class="nx">k</span><span class="p">;</span> <span class="nx">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">&lt;</span> <span class="nx">tmp</span><span class="p">[</span><span class="nx">m</span><span class="p">])</span> <span class="p">{</span> <span class="c1">// 比当前元素小，插入</span>
          <span class="nx">tmp</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cur</span><span class="p">)</span>
          <span class="nx">tmp</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
          <span class="k">break</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">tmp</span><span class="p">[</span><span class="nx">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">q</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="mi">5</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">q</span><span class="p">([</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span> <span class="o">===</span> <span class="mi">6</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">q</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="mi">5</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">q</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">355</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="mi">5</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">q</span><span class="p">([</span><span class="mi">31</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
    <span class="mi">37</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
    <span class="mi">33</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>
    <span class="mi">36</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">9</span> <span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="o">===</span> <span class="mi">16</span><span class="p">)</span>
</code></pre>
</div>

<p>第二种方法实质是用了分块处理，在数据量特别大的时候也许有用。</p>
<br>文章来源： <a href="http://jser.me/2016/02/11/N%E4%B8%AA%E6%95%B0%E4%B8%AD%E7%AC%ACK%E5%A4%A7%E7%9A%84%E6%95%B0.html">N个数中第K大的数</a> <br> 文章的标签：  <a href="http://jser.me/tag.html#javascript" class="tag">javascript</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">2015</h1>
        <p class="post-meta">
          <a href="http://limu.iteye.com/blog/2267826" target="_blank"
            <time datetime="2015-12-31T11:05:14+0800" itemProp="datePublished">Dec 31, 2015</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://limu.iteye.com" target="_blank" itemprop="url">
              <span itemprop="name">李牧</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody"><div class="iteye-blog-content-contain" style="font-size: 14px;">
<p>2015没有博客分享。</p>
<p> </p>
<p>知乎有两个回答：</p>
<p> </p>
<p><a href="https://www.zhihu.com/question/28126176/answer/39669081">前端leader要什么技能？</a></p>
<p> </p>
<p><a href="https://www.zhihu.com/question/20647148/answer/37876841">为什么前端工程师的地位普遍低于后端？</a></p>
<p> </p>
<p>2016或许会有有意思的东西释放出来，也许2017  :3</p>
<p> </p>
<p>2016新年快乐：）</p>
<p> </p>
<p> </p>
</div>
              
              <br><br>
              <span style="color:red;">
                <a href="http://limu.iteye.com/blog/2267826#comments" style="color:red;">已有 <strong>0</strong> 人发表留言，猛击-&gt;&gt;<strong>这里</strong>&lt;&lt;-参与讨论</a>
              </span>
              <br><br><br>
<span style="color:#E28822;">ITeye推荐</span>
<br>
<ul><li><a href="http://limu.iteye.com/clicks/433" target="_blank"><span style="color:red;font-weight:bold;">—软件人才免语言低担保 赴美带薪读研！— </span></a></li></ul>
<br><br><br></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">chrome开发者工具部分忽略的功能</h1>
        <p class="post-meta">
          <a href="http://jser.me/2015/08/25/chrome%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7%E9%83%A8%E5%88%86%E5%BF%BD%E7%95%A5%E7%9A%84%E5%8A%9F%E8%83%BD.html" target="_blank"
            <time datetime="2015-08-25T21:41:34+0800" itemProp="datePublished">Aug 25, 2015</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://jser.me" target="_blank" itemprop="url">
              <span itemprop="name">草依山的Javascript世界</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody"><p>算是学习笔记，一些忽略的功能</p>

<h2 id="section">快捷键</h2>

<ul>
  <li><kbd>cmd</kbd>+ <kbd>[</kbd>和<kbd>cmd</kbd> + <kbd>]</kbd>切换开发者工具的不同tab面板，这和vim里切换tab是一致的</li>
  <li><kbd>ESC</kbd> 在每个面板切换显示console面板</li>
</ul>

<h2 id="section-1">功能</h2>

<h3 id="elements">Elements</h3>

<ul>
  <li>选中元素时，右键上的<code class="highlighter-rouge">copy css path</code>和<code class="highlighter-rouge">copy xpath</code>，有时候非常有用</li>
  <li>可以通才拖拽改变节点顺序</li>
  <li>选中元素时，<kbd>h</kbd>键可以切换元素的显示隐藏(丝姐补充)</li>
</ul>

<h4 id="styles">Styles</h4>
<ul>
  <li><code class="highlighter-rouge">Toggle element state</code>可以查看不同状态下的元素样式</li>
</ul>

<h4 id="dom-breakpoints">DOM Breakpoints</h4>
<ul>
  <li>右键添加 <code class="highlighter-rouge">Break on</code>，可以用来查看节点被哪个脚本修改</li>
</ul>

<h3 id="source">Source</h3>
<ul>
  <li>添加<code class="highlighter-rouge">XHR breakpoints</code>来拦截特定的异步请求</li>
  <li><code class="highlighter-rouge">Call Stack</code> 里对语句右键可以<code class="highlighter-rouge">Restart Frame</code>在当前语句重新执行</li>
  <li>添加<code class="highlighter-rouge">black box script</code>忽略在某些库代码里不停的跳转，设置面板里<code class="highlighter-rouge">Source</code>会有管理黑盒js的功能</li>
  <li>勾选<code class="highlighter-rouge">Async</code>可以捕捉异步调用的<code class="highlighter-rouge">Call stack</code></li>
  <li><kbd>cmd</kbd>+<kbd>d</kbd> 可以多选文本 (丝姐补充)</li>
</ul>

<h3 id="console">Console</h3>
<ul>
  <li>monitorEvents监听事件，<code class="highlighter-rouge">monitorEvents(document, ['click'])</code>监听document的click事件　</li>
</ul>
<br>文章来源： <a href="http://jser.me/2015/08/25/chrome%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7%E9%83%A8%E5%88%86%E5%BF%BD%E7%95%A5%E7%9A%84%E5%8A%9F%E8%83%BD.html">chrome开发者工具部分忽略的功能</a> <br> 文章的标签：  <a href="http://jser.me/tag.html#chrome" class="tag">chrome</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">ES6初识</h1>
        <p class="post-meta">
          <a href="http://jser.me/2015/07/24/ES6%E5%88%9D%E8%AF%86.html" target="_blank"
            <time datetime="2015-07-24T13:37:05+0800" itemProp="datePublished">Jul 24, 2015</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://jser.me" target="_blank" itemprop="url">
              <span itemprop="name">草依山的Javascript世界</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody"><h2 id="es6-">ES6 简述</h2>
<p>就是新一代的Javascript标准，js引擎按照这个标准来实现Javascript这个语言，不需要把它想得太神秘，太高级，对于我们js的工程师而言，熟悉新的特性及语法，在实践过程中，提高工作效率，把项目搞好就行。当然，还有一点就像[我微博]里提到的，如果再不学习，可能过个一两年，等ES6普及开来了，一些库的代码你可能都读不懂了。</p>

<h2 id="section">兼容性</h2>
<p>由于今年才定稿，早期某些特性定稿的时候已经有『先进的浏览器』实现了部分特性，浏览器支持还不是太完整，而服务器端更激进一些，很多特性已经支持了，详细的特性支持列表，建议参考</p>

<p>http://kangax.github.io/compat-table/es6/</p>

<p>以后会是每年制定一个标准，所以也以年号来定，ES6也叫ES2015</p>

<h2 id="section-1">关于学习的一点感触</h2>
<p>语言只是工具，新特性如果能提高工资效率那必然是好特性，如果不能，然并卵
loadsh和underscore的存在，只能说明语言本身有很多未完善的地方，等到语言真的完善了，它们也就退出历史舞台了。</p>

<p>本文自带了babel，在代码区域单击，同时打开开发者工具，可以在控制台里看到输出</p>

<p>或者可以在我弄的这个<a href="http://jser.me/demos/es6-run.html">网页版的repl</a>里运行代码，在控制台里看结果</p>

<h3 id="section-2">似曾相似</h3>

<h4 id="objectassign">Object.assign</h4>

<p>类似于jQuery的$.extend，但是功能比较弱，只是浅拷贝，用处很多，也可以克隆对象</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span><span class="na">a</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
<span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">{</span><span class="na">a</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
<span class="kd">let</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">{</span><span class="na">c</span><span class="p">:{</span><span class="na">d</span><span class="p">:</span><span class="mi">1</span><span class="p">}}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">))</span>
<span class="nx">c</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">d</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre>
</div>

<h4 id="arrayprototypefind">Array.prototype.find</h4>

<p>查找到第一个符合条件的值比遍历更好用</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">].</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">v</span> <span class="o">&gt;</span> <span class="mi">3</span>
<span class="p">}))</span> <span class="c1">//4</span>
</code></pre>
</div>
<p>#### Array.prototype.filter</p>

<p>查找到所有符合条件的值</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">].</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">v</span> <span class="o">&gt;</span> <span class="mi">2</span>
<span class="p">}))</span> <span class="c1">//[3,4]</span>
</code></pre>
</div>

<h4 id="stringprototypeincludes">String.prototype.includes</h4>

<h4 id="stringprototypestartswith">String.prototype.startsWith</h4>

<h4 id="stringprototypeendswith">String.prototype.endsWith</h4>

<p>三个方法都是indexOf的加强版，其中的查询字符串只不支持正则，如果是正则会抛出错误</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">"ello"</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s2">"hell"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="p">)</span> <span class="c1">// true, 针对前4个字符</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">"ell"</span><span class="p">)</span>      <span class="p">)</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">"ell"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="p">)</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">"ell"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="p">)</span> <span class="c1">// false</span>
</code></pre>
</div>

<h3 id="section-3">字符串模板</h3>

<p>告别手工拼接字符串</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">123</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">x</span><span class="p">}</span><span class="err">`</span><span class="p">)</span> <span class="c1">//123</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">${}</code>内是标准的js语法</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">123</span>
<span class="kd">let</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">234</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{(</span><span class="nx">x</span><span class="o">+</span><span class="nx">y</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)}</span><span class="err">`</span><span class="p">)</span> <span class="c1">//165</span>
</code></pre>
</div>

<p>多行字符串</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">'hubo.hb'</span>
<span class="kd">let</span> <span class="nx">html</span> <span class="o">=</span> <span class="err">`</span>
  <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"header"</span><span class="o">&gt;</span>
      <span class="nx">$</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span>
  <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
`</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="section-4">标签模板</h4>

<p>一个可以干预模板翻译过程的函数</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">toUpper</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">toUpperCase</span><span class="p">()</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">toUpper</span><span class="err">`</span><span class="nx">Go</span> <span class="nx">up</span><span class="o">!</span><span class="err">`</span><span class="p">)</span> <span class="c1">//'GO UP!'</span>
</code></pre>
</div>
<p>第一个参数是除了替换的字符串的数组，剩下的参数是所有替换出来的值</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">valuesOnly</span><span class="p">(</span><span class="nx">stringsArray</span><span class="p">,</span> <span class="p">...</span><span class="nx">valuesArray</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">valuesArray</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'; '</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">one</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kd">var</span> <span class="nx">two</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">valuesOnly</span><span class="err">`</span><span class="nx">uno</span><span class="o">=</span><span class="nx">$</span><span class="p">{</span><span class="nx">one</span><span class="p">},</span> <span class="nx">dos</span><span class="o">=</span><span class="nx">$</span><span class="p">{</span><span class="nx">two</span><span class="p">},</span> <span class="nx">tres</span><span class="o">=</span><span class="p">?</span><span class="err">`</span><span class="p">)</span> <span class="c1">//'1; 2'</span>
</code></pre>
</div>

<h3 id="let-const">let, const</h3>
<p>let is the new var，块级作用域, 区块中存在let和const命令，凡是在声明之前就使用这些命令，就会报错。
不会有变量提升，重复定义会报错</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="s1">'use strict'</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="c1">//ReferenceError: a is not defined</span>
    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>const定义过的变量不能修改（修改无效），同样不会有变量提升，重复定义会报错</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nx">a</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">//TypeError: Assignment to constant variable.</span>
</code></pre>
</div>

<h3 id="section-5">箭头函数</h3>

<p>减少函数输入，this的自动绑定</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">func</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="s1">'I return 1'</span> <span class="c1">//无参数的情况</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">func</span><span class="p">())</span> <span class="c1">//I return 1</span>
</code></pre>
</div>

<p>单个参数时可以省略参数括号</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">odds</span> <span class="o">=</span> <span class="nx">evens</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>

<p>如果想使用比较复杂的函数体，可以用<code class="highlighter-rouge"><span class="p">{}</span></code>包起来</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">nums</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nx">fives</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
</div>

<p>如果默认返回一个对象，需要用<code class="highlighter-rouge">()</code>把对象包裹起来</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">nums</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="nx">v</span><span class="p">})))</span> <span class="c1">//[ { v: 1 }, { v: 2 }, { v: 3 }, { v: 4 } ]</span>
</code></pre>
</div>

<p>遍历操作常用</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span> <span class="c1">//单参的情况</span>
</code></pre>
</div>

<ul>
  <li>不能当作构造函数</li>
  <li>不能改变this</li>
  <li>不可以使用arguments对象</li>
</ul>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">(){</span>
    <span class="nx">setTimeout</span><span class="p">(()</span><span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">showIt</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="nx">showIt</span><span class="p">(){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'I show'</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">o</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
</code></pre>
</div>

<h3 id="section-6">更方便的对象字面量</h3>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kr">const</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">2</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">})</span> <span class="c1">//{x:1, y:2}</span>
</code></pre>
</div>

<p>属性表达式</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kr">const</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">2</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({[</span><span class="s1">'xy'</span><span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">]:</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">}</span><span class="err">`</span><span class="p">})</span>
</code></pre>
</div>

<p>同时对象字面量也支持父级调用</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">"d "</span> <span class="o">+</span> <span class="kr">super</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="rest">rest参数和展开符(…)</h3>
<p>函数定义的时候使用…变量名，必须是最后一个参数，函数体内通过变量获取参数数组</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(...</span><span class="nx">rest</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">join</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">fn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</code></pre>
</div>

<p>…把数组转化为参数序列，也可以</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">([...</span><span class="s1">'hello'</span><span class="p">])</span> <span class="c1">//["h", "e", "l", "l", "o"]</span>
</code></pre>
</div>

<h3 id="section-7">解构赋值</h3>
<p>模式匹配批量赋值，数组，字符串，对象均可</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="p">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="c1">//1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="c1">//2</span>

<span class="kr">const</span> <span class="p">[</span><span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">[...[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="c1">//1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="c1">//2</span>

<span class="kr">const</span> <span class="p">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="p">...</span><span class="nx">end</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span> <span class="c1">//1 2 [3,4]</span>

<span class="kr">const</span> <span class="p">[</span><span class="nx">h</span><span class="p">,...</span><span class="nx">ends</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'hello'</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="nx">ends</span><span class="p">)</span> <span class="c1">//h ["e", "l", "l", "o"]</span>
</code></pre>
</div>

<p>快速提取JSON里的值</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">jsonData</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">id</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
  <span class="na">status</span><span class="p">:</span> <span class="s2">"OK"</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">[</span><span class="mi">867</span><span class="p">,</span> <span class="mi">5309</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="na">data</span><span class="p">:</span> <span class="p">[,</span><span class="nx">secondData</span><span class="p">]</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">jsonData</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">)</span><span class="c1">// 42 OK 5309</span>
</code></pre>
</div>

<p>同样可以用在函数参数里</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">g</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="nx">x</span><span class="p">})</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">g</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span> <span class="c1">// 5</span>
</code></pre>
</div>

<p>可以使用默认值</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="p">[</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// true</span>
</code></pre>
</div>

<h3 id="section-8">参数默认值</h3>

<p>传入的参数为undefined时，使用默认值</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">number</span> <span class="o">=</span> <span class="p">(</span><span class="kr">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">int</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">number</span><span class="p">())</span> <span class="c1">//0</span>
</code></pre>
</div>

<p>对象参数默认值</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span> <span class="nx">body</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nx">method</span> <span class="o">=</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">}</span> <span class="o">=</span> <span class="p">{}){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fetch</span><span class="p">(</span><span class="s1">'http://jser.me'</span><span class="p">)</span>  <span class="c1">//GET</span>
<span class="nx">fetch</span><span class="p">(</span><span class="s1">'http://jser.me'</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1">//GET</span>
<span class="nx">fetch</span><span class="p">(</span><span class="s1">'http://jser.me'</span><span class="p">,</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span><span class="s1">'POST'</span><span class="p">})</span>  <span class="c1">//POST</span>
</code></pre>
</div>

<p>参数省略只能从后向前省</p>

<h3 id="section-9">类</h3>
<p>本质上类是一个语法糖，可以使用ES5来模拟，它支持原型继承，父级调用，实例方法，静态方法和构造函数</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">class</span> <span class="nx">Point</span> <span class="kr">extends</span> <span class="nx">Sharp</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">update</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>

  <span class="p">}</span>

  <span class="kr">static</span> <span class="nx">someMethod</span><span class="p">(){</span>
     <span class="k">return</span> <span class="s1">'call'</span>
  <span class="p">}</span>

  <span class="nx">toString</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'('</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="o">+</span><span class="s1">', '</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="o">+</span><span class="s1">')'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="iteratorsfor-of">Iterators和for of</h3>
<p>迭代对象可以让我们方便的使用for of进行遍历，字符串，数组，Set, Map都可以使用for of进行遍历</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="s1">'123abc'</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">n</span> <span class="nx">of</span> <span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="c1">//1 2 3 a b c</span>
<span class="p">}</span>
</code></pre>
</div>

<p>自定义一个对象的迭代</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">fibonacci</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">pre</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cur</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">next</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">[</span><span class="nx">pre</span><span class="p">,</span> <span class="nx">cur</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">pre</span> <span class="o">+</span> <span class="nx">cur</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span> <span class="na">done</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="nx">cur</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="nx">of</span> <span class="nx">fibonacci</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="k">break</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="section-10">模块</h3>
<p>与nodejs的cmd定义有较大的区别</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// lib/math.js</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span>
<span class="p">}</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">pi</span> <span class="o">=</span> <span class="mf">3.141593</span>

<span class="c1">// app.js</span>
<span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">math</span> <span class="nx">from</span> <span class="s2">"lib/math"</span>
<span class="nx">alert</span><span class="p">(</span><span class="s2">"2π = "</span> <span class="o">+</span> <span class="nx">math</span><span class="p">.</span><span class="nx">sum</span><span class="p">(</span><span class="nx">math</span><span class="p">.</span><span class="nx">pi</span><span class="p">,</span> <span class="nx">math</span><span class="p">.</span><span class="nx">pi</span><span class="p">))</span>
</code></pre>
</div>

<p>默认导出 <code class="highlighter-rouge">export default xxx</code></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// lib/mathplusplus.js</span>
<span class="kr">export</span> <span class="o">*</span> <span class="nx">from</span> <span class="s2">"lib/math"</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">e</span> <span class="o">=</span> <span class="mf">2.71828182846</span>
<span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// app.js</span>
<span class="kr">import</span> <span class="nx">ln</span><span class="p">,</span> <span class="p">{</span><span class="nx">pi</span><span class="p">,</span> <span class="nx">e</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">"lib/mathplusplus"</span>
<span class="nx">alert</span><span class="p">(</span><span class="s2">"2π = "</span> <span class="o">+</span> <span class="nx">ln</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">*</span><span class="nx">pi</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="proxy">Proxy</h3>
<p>Proxy我个人理解提供了一个对象行为钩子，我们可以用来做拦截等事情</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">get</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">receiver</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="err">`</span><span class="nx">Hello</span><span class="p">,</span> <span class="nx">$</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span><span class="o">!</span><span class="err">`</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Proxy</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">world</span><span class="p">)</span>
</code></pre>
</div>

<p>handler里可以用来挂的对象属性：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="na">get</span><span class="p">:...,</span>
  <span class="na">set</span><span class="p">:...,</span>
  <span class="na">has</span><span class="p">:...,</span>
  <span class="na">deleteProperty</span><span class="p">:...,</span>
  <span class="na">apply</span><span class="p">:...,</span>
  <span class="na">construct</span><span class="p">:...,</span>
  <span class="na">getOwnPropertyDescriptor</span><span class="p">:...,</span>
  <span class="na">defineProperty</span><span class="p">:...,</span>
  <span class="na">getPrototypeOf</span><span class="p">:...,</span>
  <span class="na">setPrototypeOf</span><span class="p">:...,</span>
  <span class="na">enumerate</span><span class="p">:...,</span>
  <span class="na">ownKeys</span><span class="p">:...,</span>
  <span class="na">preventExtensions</span><span class="p">:...,</span>
  <span class="na">isExtensible</span><span class="p">:...</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="promies">Promies</h3>
<p>不需要多讲，比较简单，大家多用就行了，用多了会上瘾。</p>

<h3 id="mapset">Map和Set</h3>
<p>两种新引入的数据结构，Map的键可以为任意对象，Map是Object的补充
Set可以理解为成员唯一的数组</p>

<h2 id="section-11">总结</h2>
<p>JS越来越完善，当然也越来越像JAVA。</p>

<h2 id="section-12">参考链接</h2>

<ul>
  <li><a href="http://kangax.github.io/compat-table/es6/">es6兼容性表格</a></li>
  <li><a href="http://chrisbuttery.com/articles/synchronous-asynchronous-javascript-with-es6-generators/">使用ES6的generators来搞同步异步</a></li>
  <li><a href="http://davidwalsh.name/es6-generators-dive">es6-generators-dive</a></li>
  <li><a href="http://davidwalsh.name/async-generators">async-generators</a></li>
  <li><a href="http://davidwalsh.name/concurrent-generators">concurrent-generators</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map">mozilla Map</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap">mozilla WeakMap</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set">mozilla Set</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap">mozilla WeakSet</a></li>
  <li><a href="http://robots.thoughtbot.com/replace-coffeescript-with-es6">使用ES6替换掉Coffeescript</a></li>
  <li><a href="http://developer.telerik.com/featured/using-javascript-next-features-es3-enterprise-world/">在ES3的环境里使用ES6特性</a></li>
  <li><a href="http://www.2ality.com/2015/01/es6-strings.html">ES6字符串</a></li>
  <li><a href="http://www.2ality.com/2014/08/es6-today.html">开始使用ES6</a></li>
</ul>







<br>文章来源： <a href="http://jser.me/2015/07/24/ES6%E5%88%9D%E8%AF%86.html">ES6初识</a> <br> 文章的标签：  <a href="http://jser.me/tag.html#javascript" class="tag">javascript</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">co源码小析</h1>
        <p class="post-meta">
          <a href="http://jser.me/2015/05/29/co%E6%BA%90%E7%A0%81%E5%B0%8F%E6%9E%90.html" target="_blank"
            <time datetime="2015-05-29T23:40:00+0800" itemProp="datePublished">May 29, 2015</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://jser.me" target="_blank" itemprop="url">
              <span itemprop="name">草依山的Javascript世界</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody"><p>作为<a href="https://github.com/koajs/koa">koa</a>的内核，<a href="https://github.com/tj/co">co</a>的代码短小精悍，可以来简单的欣赏一下（PS：我计划做一些小库的源码解析，欢迎关注和提出意见）。</p>

<p>这里我基于的版本是<a href="https://github.com/tj/co/releases/tag/4.5.2">4.5.2</a>，从4.0.0开始<code class="highlighter-rouge">co</code>返回的就是Promise了。</p>

<p>首先我们来看一下源码目录，比较简单，我们用<code class="highlighter-rouge">tree</code>命令看一下，文件的说明也写在注释里了:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>➜  co git:<span class="o">(</span>master<span class="o">)</span> tree -LaA 2
.
├── .gitignore                    <span class="c"># .git忽略文件</span>
├── .travis.yml                   <span class="c"># travis持续集成配置文件</span>
├── History.md                    <span class="c"># 历史纪录</span>
├── LICENSE                       <span class="c"># 许可</span>
├── Readme.md                     <span class="c"># 简介文档</span>
├── component.json                <span class="c"># component前端组件管理工具的描述文件</span>
├── index.js                      <span class="c"># 主文件</span>
├── package.json                  <span class="c"># npm包描述文件</span>
└── <span class="nb">test</span>                          <span class="c"># 测试目录</span>
    ├── arrays.js                 <span class="c"># 测试yield []的情况</span>
    ├── context.js                <span class="c"># 测试传递上下文是否正确</span>
    ├── generator-functions.js    <span class="c"># 测试支持生成器函数及生成器函数抛错</span>
    ├── generators.js             <span class="c"># 同上，一样一样的</span>
    ├── invalid.js                <span class="c"># 不支持的情况抛错</span>
    ├── objects.js                <span class="c"># 测试yield后为对象时的情况</span>
    ├── promises.js               <span class="c"># 测试yield后为promises的情况</span>
    ├── recursion.js              <span class="c"># 测试数组嵌套和对象嵌套的情况</span>
    ├── thunks.js                 <span class="c"># yield thunks的情况</span>
    └── wrap.js                   <span class="c"># 测试co.wrap函数</span>

7 directories, 25 files
</code></pre>
</div>

<p>先搞周边，再搞<code class="highlighter-rouge">index.js</code>文件，更多的东西可以清楚一点，也可以学到更多的东西，按上面的文件顺序来</p>

<h2 id="gitignore">.gitignore</h2>

<p>过滤了<code class="highlighter-rouge">node_modules</code>和<code class="highlighter-rouge">coverage</code>目录，<code class="highlighter-rouge">node_modules</code>是npm安装时包默认目录，<code class="highlighter-rouge">coverage</code>是执行<code class="highlighter-rouge">npm run test-cov</code>生成的目录，这个下面再细讲</p>

<h2 id="travisyml">.travis.yml</h2>

<p>指定了运行环境和持续集成的脚本</p>

<h2 id="section">几个文档</h2>

<p><code class="highlighter-rouge">History.md</code>和<code class="highlighter-rouge">LICENSE</code>就不用多说了， 如果使用<code class="highlighter-rouge">co</code>，<code class="highlighter-rouge">Readme.md</code>看看就可以用了</p>

<h2 id="packagejson">package.json</h2>

<p>包描述文件，注意<code class="highlighter-rouge">engines</code>字段，<code class="highlighter-rouge">co</code>需要在<code class="highlighter-rouge">iojs</code> 1.0.0及以上版本，<code class="highlighter-rouge">node</code>0.12.0及以上版本运行。</p>

<p>scripts字段里有三个命令</p>

<ul>
  <li>test : 测试，建议使用nvm安装iojs，然后<code class="highlighter-rouge">npm run test</code>或者<code class="highlighter-rouge">npm test</code>查看执行效果</li>
  <li>test-cov : 测试覆盖率</li>
  <li>test-travis : 在travis上使用的命令</li>
</ul>

<h2 id="test">test目录</h2>

<p>如果看更详细的使用，推荐看test目录里的文件，：）</p>

<h2 id="indexjs">index.js</h2>

<p>直接给注释了放下面了</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 *快捷方式，暂存一下数组的slice方法
 */</span>
<span class="kd">var</span> <span class="nx">slice</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">;</span>

<span class="cm">/**
 * 导出co，co['default']和co.co不知道为什么要这么干，为了兼容老版本？
 */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">co</span><span class="p">[</span><span class="s1">'default'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">co</span><span class="p">.</span><span class="nx">co</span> <span class="o">=</span> <span class="nx">co</span><span class="p">;</span>

<span class="cm">/**
 * 把一个generator函数变成返回Promise的函数
 */</span>
<span class="nx">co</span><span class="p">.</span><span class="nx">wrap</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">createPromise</span><span class="p">.</span><span class="nx">__generatorFunction__</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">createPromise</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">createPromise</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">co</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**
 * 执行一下生成器函数或者生成器返回promise
 */</span>
<span class="kd">function</span> <span class="nx">co</span><span class="p">(</span><span class="nx">gen</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//保存上下文</span>
  <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="c1">//把所有的东西都包装成一个Promise</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//传入的如果是生成器函数，运行它使用它的生成器</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">gen</span> <span class="o">===</span> <span class="s1">'function'</span><span class="p">)</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="c1">//传入的是空值，或者不是生成器，直接返回传入值</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gen</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span> <span class="o">!==</span> <span class="s1">'function'</span><span class="p">)</span> <span class="k">return</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">gen</span><span class="p">);</span>

    <span class="c1">//执行生成器的next方法</span>
    <span class="nx">onFulfilled</span><span class="p">();</span>

    <span class="cm">/**
     * 把res当生成器的入参执行next
     */</span>
    <span class="kd">function</span> <span class="nx">onFulfilled</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ret</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">next</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**
     * promise出错时的回调
     */</span>

    <span class="kd">function</span> <span class="nx">onRejected</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ret</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">next</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">next</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//生成器已经完成返回值</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="k">return</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>

      <span class="c1">//尝试将yield返回的值包装成promise</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">toPromise</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>

      <span class="c1">//value有值且为promise，继续执行</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">isPromise</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">onFulfilled</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">);</span>

      <span class="c1">//不支持的传入对象</span>
      <span class="k">return</span> <span class="nx">onRejected</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">'You may only yield a function, promise, generator, array, or object, '</span>
        <span class="o">+</span> <span class="s1">'but the following object was passed: "'</span> <span class="o">+</span> <span class="nb">String</span><span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'"'</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**
 * Convert a `yield`ed value into a promise.
 * 把一个yield之后的值转为promise
 */</span>

<span class="kd">function</span> <span class="nx">toPromise</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//传入对象为空值返回它</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>

  <span class="c1">//如果是传入promise，直接返回它自己</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>

  <span class="c1">//是生成器函数或者生成器，调用co执行</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isGeneratorFunction</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isGenerator</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="nx">co</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>

  <span class="c1">//是一个函数，那么假定它是thunk，把它转为promise</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">'function'</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">return</span> <span class="nx">thunkToPromise</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>

  <span class="c1">//数组，把数组转换为promise</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="nx">arrayToPromise</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>

  <span class="c1">//对象转为promise</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="nx">objectToPromise</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>

  <span class="c1">//跳过了上面的所有分支，返回obj自身</span>
  <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * 把thunk形式的函数转成promise
 *
 * thunk是单参数的函数，且参数为回调函数
 * function (cb){
 *    something(arg1, arg2, cb)
 * }
 */</span>

<span class="kd">function</span> <span class="nx">thunkToPromise</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//执行thunk函数</span>
    <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

      <span class="c1">//参数大于2时，除去第一个参数，返回后面的所有参数组成的一个数组</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

      <span class="c1">//promise返回</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**
 * 把一个数组转成promise，这里用了Promise.all函数
 */</span>
<span class="kd">function</span> <span class="nx">arrayToPromise</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">toPromise</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**
 * 把一个对象转成promise，它其实用的还是上面的数组转换的方式
 */</span>

<span class="kd">function</span> <span class="nx">objectToPromise</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
  <span class="c1">//生成一个结果对象</span>
  <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">();</span>
  <span class="c1">//保存和取对象的键数组</span>
  <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
  <span class="c1">//定义一个数组，用来存生成对象值生成的promise</span>
  <span class="kd">var</span> <span class="nx">promises</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="c1">//把对象值转为promise</span>
    <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">toPromise</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
    <span class="c1">//有值且成功转成了promise，</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">promise</span> <span class="o">&amp;&amp;</span> <span class="nx">isPromise</span><span class="p">(</span><span class="nx">promise</span><span class="p">))</span> <span class="nx">defer</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
    <span class="c1">//直接放到结果对象</span>
    <span class="k">else</span> <span class="nx">results</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="c1">//调用Promise.all运行所有的promise，成功后返回结果</span>
  <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">defer</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 预设results的值，这一步像是多余，对象属性默认就是undefined</span>
    <span class="c1">// 这里是为了保证结果对象肯定有这个key</span>
    <span class="c1">//results[key] = undefined;</span>
    <span class="c1">// promise放到上面的数组里，Promise.all的时候统一执行</span>
    <span class="nx">promises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">results</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
    <span class="p">}));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**
 * 判断obj是不是promise，这里只是简单的判断对象上的then属性是否是函数
 */</span>

<span class="kd">function</span> <span class="nx">isPromise</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">'function'</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">then</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * 判断对象是否是生成器，这里判断对象上的next和throw是不是函数
 */</span>
<span class="kd">function</span> <span class="nx">isGenerator</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">'function'</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="s1">'function'</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">.</span><span class="k">throw</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * 判断obj是否是生成器函数，判断有没有构造器，有的话，它的构造器名字是不是"Generatorfunction"
 * 判断构造器的原型是否是生成器
 */</span>
<span class="kd">function</span> <span class="nx">isGeneratorFunction</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">constructor</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">constructor</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">'GeneratorFunction'</span> <span class="o">===</span> <span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">'GeneratorFunction'</span> <span class="o">===</span> <span class="nx">constructor</span><span class="p">.</span><span class="nx">displayName</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">isGenerator</span><span class="p">(</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**
 * 判断val是不是一个纯对象，用val的构造器来判断
 */</span>
<span class="kd">function</span> <span class="nx">isObject</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Object</span> <span class="o">==</span> <span class="nx">val</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<br>文章来源： <a href="http://jser.me/2015/05/29/co%E6%BA%90%E7%A0%81%E5%B0%8F%E6%9E%90.html">co源码小析</a> <br> 文章的标签：  <a href="http://jser.me/tag.html#nodejs" class="tag">nodejs</a>  <a href="http://jser.me/tag.html#koa" class="tag">koa</a>  <a href="http://jser.me/tag.html#&#x6E90;&#x7801;&#x5C0F;&#x6790;" class="tag">源码小析</a></div>
      </article>
      
      <article itemscope itemtype="https://schema.org/BlogPosting" class="type" >
        <h1 class="post-title" itemprop="name headline">es6模块兼容实战</h1>
        <p class="post-meta">
          <a href="http://jser.me/2015/05/26/es6%E6%A8%A1%E5%9D%97%E5%85%BC%E5%AE%B9%E5%AE%9E%E6%88%98.html" target="_blank"
            <time datetime="2015-05-26T15:28:57+0800" itemProp="datePublished">May 26, 2015</time>
          </a>
          ・ <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a href="http://jser.me" target="_blank" itemprop="url">
              <span itemprop="name">草依山的Javascript世界</span>
            </a>
          </span>
        </p>
        <div itemprop="articleBody"><p>最近写了点es6的代码，这个小文算是对es6模块开发使用的一个小总结，并不涉及到es6的介绍</p>

<p>代码的开发环境中可能很好的支持es6，比如你用了iojs，但是在模块被别人使用的时候可能是nodejs
v0.11.xx，这个时候模块的运行环境是没有es6支持的，解决这个问题可以在模块发布前做一次编译。</p>

<p>安装<code class="highlighter-rouge">babel</code></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>npm install --save babel
</code></pre>
</div>
<p>如果使用了生成器（一般用es6的肯定会使用co啦），那还需要有<code class="highlighter-rouge">babel-runtime</code></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>npm install --save babel-runtime
</code></pre>
</div>

<p>开发的时候用es6尽情的玩耍就行了，只需要在发布前进行编译，这样对开发者而言也不是什么负担，在package.json的scripts里增加</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  ...
  "scripts": {
    "prepublish": "mkdirp es5; babel  --optional runtime lib --out-dir es5"
  }
  ...
</code></pre>
</div>

<p>上面是把整个lib目录里文件编译到es5目录，因为一般的入口文件都是直接引入lib的，我们还需要在入口文件里判断一下：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/* jshint evil:true */</span>
<span class="cm">/* global gen*/</span>
<span class="kd">function</span> <span class="nx">isSupportGenerator</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nb">eval</span><span class="p">(</span><span class="s1">'var gen = function *(){}'</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">'GeneratorFunction'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">_exports</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">isSupportGenerator</span><span class="p">())</span> <span class="p">{</span>
  <span class="nx">_exports</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib'</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">_exports</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./es5'</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">_exports</span><span class="p">;</span>
</code></pre>
</div>
<p>这个判断是否支持Generator的代码来自<a href="https://github.com/luckydrq/node-generator-detector">雪卒的代码</a></p>

<p>同时也不要忘记了在<code class="highlighter-rouge">.gitignore</code>里加上es5，这些编译的代码我们是不需要在git里维护的。</p>

<p>最后，需要加上<code class="highlighter-rouge">.npmignore</code>文件，因为如果没有这个文件的话，npm发布包的时候会按<code class="highlighter-rouge">.gitignore</code>文件里的列表忽略目录，显然，发布出去的模块，我们是需要es5目录的。</p>
<br>文章来源： <a href="http://jser.me/2015/05/26/es6%E6%A8%A1%E5%9D%97%E5%85%BC%E5%AE%B9%E5%AE%9E%E6%88%98.html">es6模块兼容实战</a> <br> 文章的标签：  <a href="http://jser.me/tag.html#es6" class="tag">es6</a>  <a href="http://jser.me/tag.html#nodejs" class="tag">nodejs</a></div>
      </article>
      
      <button class="btn-menu iconfont icon-menu"></button>
      <div class="article-helpers">
        <button class="btn-collapse iconfont icon-list"></button>
        <button class="btn-previous iconfont icon-up"></button>
        <button class="btn-next iconfont icon-down"></button>
      </div>
    </section>
    <aside>
      <h1><a href="http://fe.alimama.net">Alimama FE</a></h1>
      <nav>
        <a href="http://limu.iteye.com" target="_blank">limu的砖篮儿</a><a href="http://jser.me" target="_blank">草依山的Javascript世界</a><a href="http://www.cnblogs.com/ziyunfei/" target="_blank">博客园_紫云飞</a><a href="http://cyj.me" target="_blank">Chen Yangjian</a>
        <a href="feed.xml">订阅 <i class="iconfont icon-rss"></i></a>
      </nav>
      <ul class="repos"><li><a href=/hera/minolta-rs/minolta/index.html>minolta - Rust</a></li>
<li><a href=/thx/30/index.html>每周半小时</a></li>
<li><a href=/thx/adhoc_demo/index.html>adHoc——数据查询</a></li>
<li><a href=/thx/amp_demo/index.html>AMP-阿里妈妈营销拍档</a></li>
<li><a href=/thx/bp_demo/index.html>淘宝/天猫直通车mock数据</a></li>
<li><a href=/thx/crm_brand_demo/index.html>品牌升权</a></li>
<li><a href=/thx/dmp_demo/index.html>DMP</a></li>
<li><a href=/thx/haitao_demo/index.html>海淘</a></li>
<li><a href=/thx/hera-book/index.html>Introduction · GitBook</a></li>
<li><a href=/thx/how-to/index.html>Document</a></li>
<li><a href=/thx/image-blank-checker/sample/index.html>图片留白检测DEMO </a></li>
<li><a href=/thx/magicbox-demo/index.html>麻吉宝bp</a></li>
<li><a href=/thx/mbp_demo/index.html>MBP-直通车</a></li>
<li><a href=/thx/mkp_demo/index.html>阿里妈妈营销平台</a></li>
<li><a href=/thx/team2/index.html>团队介绍 &raquo; 前端二组</a></li>
<li><a href=/thx/vegas/index.html>THX 内部文档 -  THX</a></li>
<li><a href=/thx/zhiwuxian_demo/index.html>智无线</a></li>
<li><a href=/thx/zuanshi_45_demo/index.html>钻石展位营销平台</a></li>
<li><a href=/thx/zuanshi_demo/index.html>钻石展位+</a></li>
<li><a href=/thx/zuanshi_minisite_demo/index.html>钻石展位营销平台</a></li>
<li><a href=javascript:if(repo=prompt("仓库路径|CI-token","thx/team2|f80ae7a5b8a250ea56159c32d520ce"))document.head.appendChild(document.createElement("script")).src=`cgi-bin/add_repo.cgi?${repo}`;0>添加仓库</a></li></ul>
    </aside>
    <script src="app.js"></script>
  </body>
</html>